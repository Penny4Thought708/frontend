<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="referrer" content="no-referrer" />
  <!-- CSRF token will be populated by the session API -->
  <meta name="csrf-token" content="" />

  <!-- Basic Content-Security-Policy (prefer to move to server header for stricter control) -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; connect-src 'self' wss: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://code.jquery.com https://maps.googleapis.com; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://code.jquery.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline'; img-src 'self' data: https:; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; frame-src https://www.google.com;">

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://code.jquery.com" crossorigin>
  <link rel="preload" href="das_style.css" as="style">

  <!-- canonical (filled by JS) -->
  <link rel="canonical" href="">

  <title>Scrubber's Dashboard</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="das_style.css?v=<?php echo time(); ?>" />

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <script type="module" src="/NewApp/public/js/app.js"></script>

  <script type="module" src="public/components/ContactsMenu.js"></script>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script type="module" src="public/components/calendar-overlay.js"></script>
  <link rel="stylesheet" type="text/css" href="calling_style.css"/>
  <link rel="stylesheet" type="text/css" href="offscreenPanels_style.css"/>

  <!-- Bootstrapping session & canonical for a static HTML page -->
  <script>
    // Fill canonical to avoid needing server-side hostname injection
    (function setCanonical() {
      const link = document.querySelector('link[rel="canonical"]');
      if (link) link.href = location.href;
    })();

    // Fetch session info from an API endpoint and expose it to client code
    window._sessionPromise = (async function() {
      try {
        const res = await fetch('/NewApp/api/session.php', { credentials: 'include' });
        if (!res.ok) throw new Error('No session');
        const data = await res.json();
        if (!data || !data.fullname) throw new Error('Not logged in');
        // Expose global session
        window.user = data;
        window.user_id = data.user_id ?? null;
        window.fullname = data.fullname ?? null;
        window.avatar = data.avatar ?? null;
        if (data.csrf_token) {
          const meta = document.querySelector('meta[name="csrf-token"]');
          if (meta) meta.setAttribute('content', data.csrf_token);
          window.CSRF_TOKEN = data.csrf_token;
        }
        return data;
      } catch (err) {
        // Redirect to login if no valid session
        console.warn('Session bootstrap failed:', err);
        location.href = '/NewApp/index.html';
        return null;
      }
    })();
  </script>
</head>

<body class="dark-mode">
  <!-- Header -->
  <header class="site-header">
    <div class="brand-logo">
      <span class="brand">Scrubber's</span>
    </div>
    <nav class="nav-links">
      <a href="#">Home</a>
      <a href="services.html">Services</a>
      <a href="project.html">Projects</a>
      <a href="#">Contact</a>
    </nav>

    <div class="auth-section">
      <div class="welcome">
        <h3>Welcome, <span id="welcomeName">User</span>!</h3>
        <p>You are now logged in to your Scrubbers Network.</p>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <main>
    <div id="introduction"></div>
    <div id="intro_arrow" class="intro-arrow"></div>

    <div id="notification_container"></div>

    <div id="side_nav_buttons">
      <button id="btn_search" title="Search For Local Help">üîç</button>
      <button id="btn_chat_main" title="Start Chat">üí¨</button>
      <button id="contact_widget" title="Contacts">
        <img src="img/Contacts.png" alt="contact_widget" class="contact_icon">
      </button>
      <button id="voicemail_Btn" title="Voicemail">
        <img src="img/voicemail.png" alt="voicemail">
      </button>
      <button id="btn_notifications" title="Notifications">üîî</button>
      <button id="btn_settings" title="Settings"><span class="material-symbols-outlined">settings</span></button>
      <button id="toggleBtn" title="Theme">üåô</button>
      <hr>
      <br><br><br><br><br><br><br><br><br><br><br><br>
      <button class="logoutButton" onclick="window.location='logout.php'" title="Logout" ><img src="img/logout.png" alt=""></button>
      <button id="btn_help" title="Help">‚ùì</button>
    </div>

    <div id="contact_window">
      <div id="leftcontent">
        <div id="contact_box">
          <div id="menu_Btn_contact">
            <img src="img/menu.png" alt="contact-menu">
          </div>
          <div id="contact_menu_box">
            <ul id="contact_menu_list">
              <li id="select_contact">Select</li>
              <li id="block_contact">Block Contact</li>
              <li id="delete_contact">Deleted Contact</li>
              <li id="view_profile">View Profile</li>
              <li id="add_contact">Add Contact</li>
              <li id="settings">Settings</li>
            </ul>
          </div>

          <div class="profile_card">
            <!-- Avatar -->
            <div class="profile-avatar">
              <div class="status-dot online"><h3>Online</h3></div>

              <img id="profilePreview" src="/NewApp/img/defaultUser.png" alt="Profile Picture">

              <div class="profile_chgBtn">
                <button id="enhanceAvatar" class="upload-btn">Enhance Photo</button>
                <label for="profileImage" class="upload-btn">Change Photo</label>
                <input type="file" id="profileImage" accept="image/*">
                <button id="removeAvatar" class="delete-account-btn">Remove Avatar</button>
              </div>
            </div>

            <!-- Info -->
            <div class="profile-info">
              <h2 class="profile-name" id="profileName">User</h2>
              <p class="profile-username" id="profileUsername">@user</p>

              <!-- Bio -->
              <div class="profile-field">
                <label>Bio</label>
                <textarea name="bio" id="bioInput" placeholder="Write something about yourself..."></textarea>
              </div>

              <!-- Display Name -->
              <div class="profile-field">
                <label>Display Name</label>
                <input type="text" name="fullname" id="fullnameInput" value=""/>
              </div>

              <!-- Email -->
              <div class="profile-field">
                <label>Email</label>
                <input type="email" name="email" id="emailInput" placeholder="">
              </div>

              <!-- Password Change -->
              <div class="profile-field">
                <label>Current Password</label>
                <input type="password" id="currentPasswordInput" placeholder="Enter current password">
              </div>

              <div class="profile-field">
                <label>New Password</label>
                <input type="password" id="newPasswordInput" placeholder="Enter new password">
              </div>

              <div class="profile-field">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPasswordInput" placeholder="Confirm new password">
              </div>

              <button class="save-profile-btn" id="changePasswordBtn">Change Password</button>

              <!-- Social Links -->
              <div class="profile-social">
                <label>Social Links</label>
                <div class="social-inputs">
                  <input type="url" name="website" id="websiteInput" placeholder="Website URL">
                  <input type="url" name="twitter" id="twitterInput" placeholder="Twitter / X">
                  <input type="url" name="instagram" id="instagramInput" placeholder="Instagram">
                </div>
              </div>

              <!-- Toggles -->
              <label class="toggle-row">
                <span>Show Online Status</span>
                <input type="checkbox" name="show_online" id="showOnlineInput" checked>
                <div class="toggle-slider"></div>
              </label>

              <label class="toggle-row">
                <span>Allow Messages</span>
                <input type="checkbox" name="allow_messages" id="allowMessagesInput" checked>
                <div class="toggle-slider"></div>
              </label>

              <!-- Actions -->
              <div class="profile-actions">
                <button class="save-profile-btn" id="saveProfileBtn">Save Changes</button>
                <a href="logout.php" class="logout-btn" title="Logout">Log Out</a>
                <button class="delete-account-btn" id="deleteAccountBtn">Delete Account</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="rightcontent"></div>
    </div>

    <!-- ... rest of your page unchanged ... -->

  </main>

  <!-- Footer (unchanged) -->
  <footer class="site-footer">
    <div class="footer-content">
      <p>&copy; 2025 DIY Connect. All rights reserved.</p>
      <nav class="footer-nav">
        <a href="/about">About Us</a>
        <a href="/services">Services</a>
        <a href="/contact">Contact</a>
        <a href="/privacy">Privacy Policy</a>
      </nav>
      <div class="social-links">
        <a href="https://facebook.com" target="_blank" rel="noopener"><i class="fab fa-facebook-f"></i> Facebook</a>
        <a href="https://twitter.com" target="_blank" rel="noopener"><i class="fab fa-twitter"></i> Twitter</a>
        <a href="https://instagram.com" target="_blank" rel="noopener"><i class="fab fa-instagram"></i> Instagram</a>
      </div>
    </div>
  </footer>

  <audio id="ringtone" src="ringtone.mp3" preload="auto"></audio>
  <audio id="ringback" src="ringback.mp3" preload="auto"></audio>
  <audio id="notification" src="notification.mp3" preload="auto"></audio>

  <script src="buttons-functions.js"></script>
  <script type="module" src="public/js/dashboard/DashboardInit.js"></script>

  <!-- Session-based DOM initialization (runs after all DOM is available) -->
<script type="module">
import { API_BASE } from "./config.js";

async function loadUser() {
  try {
    const res = await fetch(`${API_BASE}/auth/me`, {
      credentials: "include"
    });

    const data = await res.json();

    if (!data.success) {
      window.location.href = "/login.html";
      return;
    }

    // Fill UI
    document.getElementById("welcome").textContent =
      `Welcome, ${data.user.fullname}!`;

    document.getElementById("welcomeName").textContent = data.user.fullname;
    document.getElementById("profileName").textContent = data.user.fullname;
    document.getElementById("profileUsername").textContent =
      "@" + data.user.fullname.replace(/\s+/g, "").toLowerCase();

    const emailInput = document.getElementById("emailInput");
    if (emailInput) emailInput.value = data.user.email;

    const fullnameInput = document.getElementById("fullnameInput");
    if (fullnameInput) fullnameInput.value = data.user.fullname;

    // Avatar
    const avatarUrl = data.user.avatar
      ? `${API_BASE}/${data.user.avatar}?t=${Date.now()}`
      : "./img/defaultUser.png";

    const profilePreview = document.getElementById("profilePreview");
    if (profilePreview) profilePreview.src = avatarUrl;

    const localAvatarImg = document.getElementById("localAvatarImg");
    if (localAvatarImg) localAvatarImg.src = avatarUrl;

    // Expose globally
    window.user = data.user;
    window.user_id = data.user.user_id;
    window.fullname = data.user.fullname;
    window.avatar = data.user.avatar;

  } catch (err) {
    console.error("Auth check failed", err);
    window.location.href = "/login.html";
  }
}

loadUser();
</script>


  <!-- Remaining script imports (unchanged) -->
  <div id="image-viewer-overlay" aria-hidden="true">
    <button id="image-prev" class="image-nav-btn">‚ùÆ</button>
    <img id="image-viewer-img" src="" alt="Image viewer">
    <button id="image-next" class="image-nav-btn">‚ùØ</button>
  </div>

  <div id="hiddenMessagesPanel" class="hidden-panel" aria-hidden="true">
    <h3>Hidden Messages</h3>
    <div id="hiddenList"></div>
    <button onclick="closeHiddenPanel()">Close</button>
  </div>

</body>
 
<script type="module" src="/NewApp/public/js/socket.js"></script> <script type="module" src="/NewApp/public/js/session.js"></script> <script type="module" src="/NewApp/public/js/dashboard/contacts.js"></script> <script type="module" src="/NewApp/public/js/messaging.js"></script>
<script  src="SettingsController.js">document.addEventListener("DOMContentLoaded", () => {
  SettingsController.init();
  openMainSettings();
});</script>
<script src="SettingsStore.js"></script>
<script src="DeviceManager.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (typeof DeviceManager !== "undefined" && DeviceManager.init) {
    DeviceManager.init();
  }
});
</script>
<script src="MediaPreview.js">document.getElementById("test_speaker_btn").addEventListener("click", () => {
  MediaPreview.testSpeaker(SettingsStore.data.speaker);
});
</script>


<script type="module">

document.addEventListener("DOMContentLoaded", async () => {
  await DeviceManager.init();        // permissions + device list
  await SettingsController.init();   // binds UI + applies settings
});
document.getElementById("test_speaker_btn")?.addEventListener("click", () => {
  MediaPreview.testSpeaker(SettingsStore.data.speaker);
});


import { socket } from "/NewApp/public/js/socket.js";
import {
  updateLocalContact,
  registerPresence
} from "/NewApp/public/js/dashboard/contacts.js";
import { getMyUserId } from "/NewApp/public/js/session.js";

/* -------------------------------------------------------
   DOM READY
------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  socket.on("connect", registerPresence);

  /* -------------------------------------------------------
     ELEMENTS
  ------------------------------------------------------- */
  const profileInput       = document.getElementById("profileImage");
  const profilePreview     = document.getElementById("profilePreview");
  const avatarContainer    = document.querySelector(".profile-avatar");
  const enhanceBtn         = document.getElementById("enhanceAvatar");
  const removeBtn          = document.getElementById("removeAvatar");
  const saveBtn            = document.getElementById("saveProfileBtn");
  const deleteBtn          = document.getElementById("deleteAccountBtn");
  const showOnlineInput    = document.getElementById("showOnlineInput");
  const allowMessagesInput = document.getElementById("allowMessagesInput");

  // DB-style avatar path (e.g. "uploads/avatars/x.png")
  let currentAvatarPath = null;

  // If the profile UI isn't present on this page, skip initializing profile handlers
  if (
    !profileInput ||
    !profilePreview ||
    !avatarContainer ||
    !enhanceBtn ||
    !removeBtn ||
    !saveBtn ||
    !deleteBtn ||
    !showOnlineInput ||
    !allowMessagesInput
  ) {
    console.warn("[Profile] Profile UI elements not found; skipping profile initialization.");
    return;
  }

  /* -------------------------------------------------------
     HELPERS
  ------------------------------------------------------- */

  /**
   * Convert DB path ‚Üí full display URL with cache-busting.
   */
  function buildDisplayUrlFromDbPath(dbPath) {
    if (!dbPath) return "/NewApp/img/defaultUser.png";

    let clean = dbPath.replace(/^\/+/, "");
    if (!clean.startsWith("NewApp/")) {
      clean = `NewApp/${clean}`;
    }

    return `/${clean}?t=${Date.now()}`;
  }

  /**
   * Preview a selected file immediately (data URL).
   */
  function previewFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      profilePreview.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  /**
   * Upload avatar to backend and update UI + real-time presence.
   */
  async function uploadAvatar(file) {
    const formData = new FormData();
    formData.append("profileImage", file);

    try {
      const res = await fetch("upload_avatar.php", {
        method: "POST",
        body: formData
      }).then((r) => r.json());

      if (res.status === "ok" && res.avatarUrl) {
        currentAvatarPath = res.avatarUrl;

        const displayUrl = buildDisplayUrlFromDbPath(currentAvatarPath);
        profilePreview.src = displayUrl;

        socket.emit("profile:update", { avatar: currentAvatarPath });

        updateLocalContact(getMyUserId(), {
          contact_avatar: currentAvatarPath
        });
      }
    } catch (err) {
      console.error("[Profile] Avatar upload error:", err);
    }
  }

  /**
   * Validate + process avatar file.
   */
  function handleAvatarFile(file) {
    const allowed = ["image/jpeg", "image/png", "image/webp"];
    if (!allowed.includes(file.type)) {
      alert("Only JPG, PNG, or WEBP allowed.");
      return;
    }

    previewFile(file);
    uploadAvatar(file);
  }

  /* -------------------------------------------------------
     AVATAR UPLOAD (CLICK)
  ------------------------------------------------------- */
  profileInput.addEventListener("change", () => {
    const file = profileInput.files[0];
    if (file) handleAvatarFile(file);
  });

  /* -------------------------------------------------------
     DRAG & DROP
  ------------------------------------------------------- */
  ["dragenter", "dragover"].forEach((evt) =>
    avatarContainer.addEventListener(evt, (e) => {
      e.preventDefault();
      avatarContainer.classList.add("drag-over");
    })
  );

  ["dragleave", "drop"].forEach((evt) =>
    avatarContainer.addEventListener(evt, (e) => {
      e.preventDefault();
      avatarContainer.classList.remove("drag-over");
    })
  );

  avatarContainer.addEventListener("drop", (e) => {
    const file = e.dataTransfer.files[0];
    if (file) handleAvatarFile(file);
  });

  /* -------------------------------------------------------
     ENHANCE AVATAR
  ------------------------------------------------------- */
  enhanceBtn.addEventListener("click", async () => {
    try {
      const data = await fetch("enhance_avatar.php", {
        method: "POST"
      }).then((r) => r.json());

      if (data.status === "ok" && data.avatarUrl) {
        currentAvatarPath = data.avatarUrl;

        const displayUrl = buildDisplayUrlFromDbPath(currentAvatarPath);
        profilePreview.src = displayUrl;

        socket.emit("profile:update", { avatar: currentAvatarPath });
        updateLocalContact(getMyUserId(), {
          contact_avatar: currentAvatarPath
        });
      } else {
        alert("Could not enhance avatar.");
      }
    } catch {
      alert("Error enhancing avatar.");
    }
  });

  /* -------------------------------------------------------
     REMOVE AVATAR
  ------------------------------------------------------- */
  removeBtn.addEventListener("click", async () => {
    if (!confirm("Remove your avatar?")) return;

    try {
      const res = await fetch("remove_avatar.php", {
        method: "POST"
      }).then((r) => r.text());

      if (res === "success") {
        currentAvatarPath = null;
        profilePreview.src = "/NewApp/img/defaultUser.png";

        socket.emit("profile:update", { avatar: null });
        updateLocalContact(getMyUserId(), { contact_avatar: null });
      }
    } catch (err) {
      console.error("[Profile] Remove avatar error:", err);
    }
  });

  /* -------------------------------------------------------
     SAVE PROFILE
  ------------------------------------------------------- */
  saveBtn.addEventListener("click", async () => {
    const fullname        = document.getElementById("fullnameInput").value;
    const email           = document.getElementById("emailInput").value;
    const bio             = document.getElementById("bioInput").value;
    const website         = document.getElementById("websiteInput").value;
    const twitter         = document.getElementById("twitterInput").value;
    const instagram       = document.getElementById("instagramInput").value;
    const show_online     = showOnlineInput.checked ? 1 : 0;
    const allow_messages  = allowMessagesInput.checked ? 1 : 0;

    const data = new FormData();
    data.append("fullname", fullname);
    data.append("email", email);
    data.append("bio", bio);
    data.append("website", website);
    data.append("twitter", twitter);
    data.append("instagram", instagram);
    data.append("show_online", show_online);
    data.append("allow_messages", allow_messages);

    try {
      const res = await fetch("/NewApp/update_profile.php", {
        method: "POST",
        body: data
      }).then((r) => r.json());

      if (res.success) {
        alert("Profile updated successfully");

        const payload = {
          fullname,
          email,
          bio,
          website,
          twitter,
          instagram,
          show_online,
          allow_messages,
          avatar: currentAvatarPath
        };

        socket.emit("profile:update", payload);
        updateLocalContact(getMyUserId(), payload);
      } else {
        alert(res.error || "Error updating profile");
      }
    } catch (err) {
      console.error("[Profile] Save error:", err);
    }
  });

  /* -------------------------------------------------------
     DELETE ACCOUNT
  ------------------------------------------------------- */
  deleteBtn.addEventListener("click", async () => {
    if (!confirm("Are you sure you want to delete your account?")) return;

    try {
      const res = await fetch("delete_account.php", {
        method: "POST"
      }).then((r) => r.text());

      if (res === "success") {
        window.location.href = "logout.php";
      }
    } catch (err) {
      console.error("[Profile] Delete account error:", err);
    }
  });

  /* -------------------------------------------------------
     REAL-TIME PROFILE UPDATES (SELF)
  ------------------------------------------------------- */
  socket.on("profile:updated", (data) => {
    if (data.user_id !== getMyUserId()) return;

    if (data.avatar !== undefined) {
      currentAvatarPath = data.avatar;
      profilePreview.src = buildDisplayUrlFromDbPath(currentAvatarPath);
    }

    updateLocalContact(getMyUserId(), data);
  });
});
document.addEventListener("DOMContentLoaded", () => {
  const panel            = document.getElementById("search_panel");
  const closeBtn         = document.getElementById("close_search");
  const input            = document.getElementById("contractor_query_panel");
  const submitBtn        = document.getElementById("search_submit_panel");
  const resultsContainer = document.getElementById("search_results");
  const autocompleteList = document.getElementById("autocomplete_list_panel");
  const mapFrame         = document.getElementById("contractor_map");
  const filterChips      = document.querySelectorAll(".filter-chip");

  let currentQuery    = "";
  let currentCategory = "all";
  let currentPage     = 1;
  let isLoading       = false;
  let hasMore         = true;

  let userLat = null;
  let userLng = null;

  /* ---------------------------------------
     Open / Close panel
  --------------------------------------- */

  window.openSearchPanel = function () {
    panel.classList.add("active");

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;

          updateMap("contractors near me");
          resetAndSearch();
        },
        () => {
          console.warn("User denied geolocation");
          updateMap("contractors near me");
          resetAndSearch();
        }
      );
    } else {
      updateMap("contractors near me");
      resetAndSearch();
    }
  };

  closeBtn.addEventListener("click", () => {
    panel.classList.add("closing");
    setTimeout(() => {
      panel.classList.remove("active", "closing");
    }, 450);
  });

  /* ---------------------------------------
     Debounce
  --------------------------------------- */

  function debounce(fn, delay = 300) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  /* ---------------------------------------
     Autocomplete (static demo)
  --------------------------------------- */

 function updateAutocomplete(query) {
  autocompleteList.innerHTML = "";

  if (query.length < 2) {
    autocompleteList.style.display = "none";
    return;
  }

  const suggestions = [
    "Roofing contractor in Whiteville",
    "Plumbing contractor",
    "HVAC repair",
    "Electrical services",
    "General contractor",
  ].filter((s) => s.toLowerCase().includes(query.toLowerCase()));

  if (suggestions.length === 0) {
    autocompleteList.style.display = "none";
    return;
  }

  suggestions.forEach((item) => {
    const li = document.createElement("li");
    li.textContent = item;
    li.addEventListener("click", () => {
      input.value = item;
      autocompleteList.style.display = "none";
      currentQuery = item;
      resetAndSearch();
    });
    autocompleteList.appendChild(li);
  });

  autocompleteList.style.display = "block";
}


  input.addEventListener(
    "input",
    debounce(() => {
      currentQuery = input.value;
      updateAutocomplete(currentQuery);
    }, 250)
  );

  /* ---------------------------------------
     Filters
  --------------------------------------- */

  filterChips.forEach((chip) => {
    chip.addEventListener("click", () => {
      filterChips.forEach((c) => c.classList.remove("active"));
      chip.classList.add("active");
      currentCategory = chip.dataset.category || "all";
      resetAndSearch();
    });
  });

  /* ---------------------------------------
     Manual search
  --------------------------------------- */

  submitBtn.addEventListener("click", () => {
    currentQuery = input.value;
    resetAndSearch();
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      currentQuery = input.value;
      autocompleteList.innerHTML = "";
      resetAndSearch();
    }
  });

  /* ---------------------------------------
     Core search helpers
  --------------------------------------- */

  function resetAndSearch() {
    currentPage = 1;
    hasMore = true;
    resultsContainer.innerHTML = "";
    performSearch();
  }

  function showLoadingSkeleton() {
    const skeleton = document.createElement("div");
    skeleton.className = "result-card skeleton";
    skeleton.innerHTML = `
      <div class="skeleton-line title"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line short"></div>
    `;
    resultsContainer.appendChild(skeleton);
  }

  function clearSkeletons() {
    resultsContainer
      .querySelectorAll(".skeleton")
      .forEach((el) => el.remove());
  }

  async function performSearch() {
    if (isLoading || !hasMore) return;
    isLoading = true;

    showLoadingSkeleton();

    const params = new URLSearchParams({
      q: currentQuery,
      category: currentCategory,
      page: String(currentPage),
    });

    if (userLat && userLng) {
      params.append("lat", userLat);
      params.append("lng", userLng);
    }

    try {
      const res = await fetch(
        `/NewApp/search_contractors.php?${params.toString()}`
      );
      const data = await res.json();
      clearSkeletons();

      if (!data.success) {
        if (currentPage === 1) {
          resultsContainer.innerHTML =
            `<p class="empty-state">No results. Try another search.</p>`;
        }
        isLoading = false;
        return;
      }

      if (currentPage === 1 && data.results.length === 0) {
        resultsContainer.innerHTML =
          `<p class="empty-state">No contractors found for that search.</p>`;
        hasMore = false;
        isLoading = false;
        return;
      }

      data.results.forEach((item) => {
        resultsContainer.appendChild(renderResultCard(item));
      });

      hasMore = data.hasMore;
      if (hasMore) currentPage += 1;

      const mapQuery =
        itemToMapQuery(data.results[0]) ||
        currentQuery ||
        "contractors near me";
      updateMap(mapQuery);
    } catch (err) {
      clearSkeletons();
      console.error("[Search] Error:", err);
    } finally {
      isLoading = false;
    }
  }

  function itemToMapQuery(item) {
    if (!item) return "";
    const parts = [item.name, item.city, item.state].filter(Boolean);
    return parts.join(" ");
  }

  function updateMap(query) {
    if (!mapFrame) return;

    const base = "https://www.google.com/maps/embed/v1/search";
    const key = "AIzaSyDbjrFx19WFXQCu-IoFxjbju8WaG5E8phA";

    let url = `${base}?key=${key}&q=${encodeURIComponent(query)}`;

    if (userLat && userLng) {
      // center is a separate parameter, not part of q
      url += `&center=${userLat},${userLng}`;
    }

    mapFrame.src = url;
  }

  /* ---------------------------------------
     Result card (distance-ready)
  --------------------------------------- */

  function renderResultCard(item) {
    const card = document.createElement("div");
    card.className = "result-card";

    const rating   = item.rating ? Number(item.rating).toFixed(1) : "N/A";
    const location = [item.city, item.state].filter(Boolean).join(", ");
    const distance = item.distance
      ? `${Number(item.distance).toFixed(1)} km away`
      : "";

    card.innerHTML = `
      <h3>${item.name}</h3>
      <p>${item.description ?? ""}</p>
      <div class="result-meta">
        <span class="meta-item">
          <span class="material-symbols-outlined">star</span>
          <span>${rating}</span>
        </span>

        ${location ? `
          <span class="meta-item">
            <span class="material-symbols-outlined">location_on</span>
            <span>${location}</span>
          </span>` : ""}

        ${distance ? `
          <span class="meta-item">
            <span class="material-symbols-outlined">pin_drop</span>
            <span>${distance}</span>
          </span>` : ""}

        ${item.phone ? `
          <span class="meta-item">
            <span class="material-symbols-outlined">call</span>
            <a href="tel:${item.phone}">${item.phone}</a>
          </span>` : ""}

        ${item.website ? `
          <span class="meta-item">
            <span class="material-symbols-outlined">language</span>
            <a href="${item.website}" target="_blank" rel="noopener">Website</a>
          </span>` : ""}
      </div>
    `;
    return card;
  }

  /* ---------------------------------------
     Infinite scroll
  --------------------------------------- */

  resultsContainer.addEventListener("scroll", () => {
    const { scrollTop, scrollHeight, clientHeight } = resultsContainer;
    if (scrollTop + clientHeight >= scrollHeight - 80) {
      if (!isLoading && hasMore) {
        performSearch();
      }
    }
  });
});



</script>





</html>


